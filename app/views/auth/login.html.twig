<?php
require_once './autoload.php';
$error_message = null;

if (!empty($_SESSION)) {
    header('Location: dashboard.php');
}

if ($_SERVER['REQUEST_METHOD'] === 'POST') {
    $username = trim($_POST['username']); // Élimine les espaces inutiles
    $password = $_POST['password'];

    // Vérifie que les champs ne sont pas vides
    if (empty($username) || empty($password)) {
        $error_message = "Veuillez remplir tous les champs.";
    } else {
        try {
            // Prépare la requête pour récupérer l'utilisateur
            $user = getUser($username, $pdo);

            if ($user && password_verify($password, $user['password'])) {
                // Authentification réussie
                $_SESSION['user'] = [
                    'id' => $user['id'],
                ];
                header('Location: dashboard.php');
            } else {
                // Authentification échouée
                $error_message = "Identifiant ou mot de passe incorrect.";
            }
        } catch (Exception $e) {
            // Log l'erreur pour analyse (sans afficher au client)
            error_log($e->getMessage());
            $error_message = "Une erreur est survenue. Veuillez réessayer plus tard.";
        }
    }
}
?>

<?php include './templates/header.php';?>


<body>
    <div class="login-container">
            <h1>Connexion</h1>
            <form method="post">
                <input type="text" name="username" placeholder="Nom d'utilisateur" required>
                <input type="password" name="password" placeholder="Mot de passe" required>
                <button type="submit">Se connecter</button>
            </form>
    </div>
</body>

<?php include './templates/footer.php';?>
